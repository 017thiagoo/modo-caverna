<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Modo Caverna OS - Sistema de Produtividade para Engenharia">
    <title>Modo Caverna OS | System Kernel v6.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;300;400;500;700&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Palette: Deep Red Ops */
            --color-bg-body: #050505;
            --color-bg-sidebar: #090909;
            --color-bg-card: rgba(18, 18, 18, 0.65);
            --color-bg-card-hover: rgba(25, 25, 25, 0.85);
            --color-bg-input: #0f0f0f;
            
            --color-primary: #ef4444;
            --color-primary-dark: #b91c1c;
            --color-primary-glow: rgba(239, 68, 68, 0.15);
            --color-primary-border: rgba(239, 68, 68, 0.3);
            
            --color-text-main: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-text-dark: #4b5563;
            
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;

            /* Branding Bancário */
            --brand-nubank: #820ad1;
            --brand-inter: #ff7a00;
            --brand-bb: #fce300;
            --brand-caixa: #005ca9;

            /* Effects */
            --glass-blur: blur(16px);
            --glass-border: 1px solid rgba(255, 255, 255, 0.06);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-neon: 0 0 15px var(--color-primary-glow);
            
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-body);
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }

        body {
            background-color: var(--color-bg-body);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(239, 68, 68, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(239, 68, 68, 0.03) 0%, transparent 20%),
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 30px 30px, 30px 30px;
            color: var(--color-text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 15px;
            line-height: 1.5;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease forwards; }

        /* =========================================
           2. SIDEBAR NAVIGATION (DESKTOP)
           ========================================= */
        .sidebar {
            width: 280px;
            background: var(--color-bg-sidebar);
            border-right: var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            z-index: 50;
            transition: var(--transition-normal);
            backdrop-filter: blur(10px);
        }

        .brand-container {
            margin-bottom: 3rem;
            padding-left: 0.5rem;
        }

        /* --- Adicione no final do seu CSS --- */

        .brand-logo-container {
            display: flex;
            align-items: center;
            gap: 12px; /* Espaço entre ícone e texto */
        }

        .svg-logo {
            width: 40px; /* Tamanho do ícone */
            height: 40px;
            /* O SVG usará as cores variáveis do seu sistema */
        }

        /* Ajuste fino para o texto ficar exatamente ao lado */
        .brand-text {
            font-size: 1.1rem;
            color: var(--color-primary);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            line-height: 1; /* Importante para alinhamento vertical */
        }

        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            padding: 14px 16px;
            text-align: left;
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .nav-btn i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
            transition: var(--transition-fast);
        }

        .nav-btn:hover {
            color: var(--color-text-main);
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-btn.active {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
            color: var(--color-primary);
            border-left: 3px solid var(--color-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .nav-btn.active i {
            transform: scale(1.1);
            text-shadow: 0 0 10px var(--color-primary);
        }

        .youtube-widget {
            margin-top: auto; /* Mantém no rodapé da sidebar */
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 1.5rem;
        }

        .youtube-header {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 1px;
        }

        /* Container responsivo para o vídeo */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* Proporção 16:9 (Padrão YouTube) */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* =========================================
           3. MAIN CONTENT AREA
           ========================================= */
        .main-content {
            flex: 1;
            padding: 2.5rem 3rem;
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth;
        }

        /* Header Section */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 3rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 1.5rem;
        }

        .header-title-group h1 {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 5px;
            background: linear-gradient(to right, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        .system-status {
            font-size: 0.8rem;
            color: var(--color-success);
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--color-success);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--color-success);
            animation: pulse 2s infinite;
        }

        /* =========================================
           4. GRID SYSTEM & CARDS
           ========================================= */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-8 { grid-column: span 8; }
        .col-12 { grid-column: span 12; }

        .card {
            background: var(--color-bg-card);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 1.8rem;
            backdrop-filter: var(--glass-blur);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: var(--color-bg-card-hover);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, var(--color-primary), transparent);
            opacity: 0;
            transition: 0.3s;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-action-btn {
            background: transparent;
            border: 1px solid var(--color-primary-border);
            color: var(--color-primary);
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        .card-action-btn:hover {
            background: var(--color-primary-glow);
            border-color: var(--color-primary);
        }

        /* =========================================
           5. FINANCEIRO COMPONENTS
           ========================================= */
        .bank-card {
            background: linear-gradient(145deg, #18181b, #050505);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 1.2rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            border-left: 4px solid #333;
        }

        .bank-card:hover {
            transform: translateX(5px);
            background: #202022;
        }

        /* Bank Branding */
        .bank-nubank { border-left-color: var(--brand-nubank); }
        .bank-inter { border-left-color: var(--brand-inter); }
        .bank-bb { border-left-color: var(--brand-bb); }
        .bank-caixa { border-left-color: var(--brand-caixa); }

        .bank-info h4 {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .bank-balance {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-text-main);
        }

        /* Transaction List */
        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 0.9rem;
        }

        .transaction-item:last-child { border-bottom: none; }

        .trans-meta {
            display: flex;
            flex-direction: column;
        }

        .trans-desc { font-weight: 500; color: #eee; }
        .trans-date { font-size: 0.75rem; color: #666; }

        .amount-inc { color: var(--color-success); font-weight: 600; }
        .amount-exp { color: var(--color-danger); font-weight: 600; }

        /* =========================================
           6. FORMS & INPUTS
           ========================================= */
        .form-control {
            width: 100%;
            background: var(--color-bg-input);
            border: 1px solid #333;
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            outline: none;
            transition: 0.2s;
            margin-bottom: 10px;
        }

        .form-control:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
            transform: translateY(-1px);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            flex: 1; /* Para ocupar espaço igual */
        }
        .btn-success:hover { background: #059669; }

        .btn-danger {
            background: var(--color-danger);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            flex: 1; /* Para ocupar espaço igual */
        }
        .btn-danger:hover { background: #b91c1c; }

        /* =========================================
           7. TASK & HABIT STYLES
           ========================================= */
        .task-item {
            background: rgba(255,255,255,0.02);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .task-item:hover {
            border-color: rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04);
        }

        .priority-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            margin-right: 8px;
            border: 1px solid currentColor;
        }
        .p-high { color: var(--color-danger); background: rgba(239,68,68,0.1); }
        .p-med { color: var(--color-warning); background: rgba(245,158,11,0.1); }
        .p-low { color: var(--color-success); background: rgba(16,185,129,0.1); }

        .habit-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .habit-card-mini {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .habit-days {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .day-check {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #555;
            transition: 0.2s;
        }

        .day-check.checked {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
            box-shadow: 0 0 10px var(--color-primary-glow);
        }

        /* =========================================
           8. MOBILE NAVIGATION (BOTTOM BAR)
           ========================================= */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px 20px 30px 20px; /* Extra padding for iOS home indicator */
            justify-content: space-around;
            z-index: 1000;
        }

        .mob-link {
            background: none;
            border: none;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            gap: 4px;
            cursor: pointer;
            transition: 0.2s;
        }

        .mob-link i {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }

        .mob-link.active {
            color: var(--color-primary);
            transform: translateY(-2px);
        }

        /* =========================================
           9. UTILITIES & ANIMATIONS
           ========================================= */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Media Queries */
        @media (max-width: 1024px) {
            .grid-container { grid-template-columns: 1fr; }
            .col-4, .col-6, .col-8, .col-12 { grid-column: span 1; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .main-content { padding: 1.5rem 1rem 7rem 1rem; }
            .header-title-group h1 { font-size: 1.8rem; }
            .grid-container { display: flex; flex-direction: column; gap: 1.5rem; }
            .card { padding: 1.2rem; }
        }

        /* Força o popup do calendário a ser escuro (Nativo do navegador) */
        :root {
            color-scheme: dark; 
        }

        /* Estilo do Input de Data no Modo Caverna */
        input[type="date"] {
            background-color: var(--color-bg-input);
            color: var(--color-text-main);
            border: 1px solid #333;
            border-radius: var(--radius-sm);
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Pinta o ícone do calendário nativo de VERMELHO */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(28%) sepia(93%) saturate(2256%) hue-rotate(346deg) brightness(96%) contrast(92%);
            cursor: pointer;
        }

        /* Botão específico para abrir calendário (Estilo ícone) */
        .btn-calendar {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-primary-border);
            color: var(--color-primary);
            width: 42px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .btn-calendar:hover {
            background: var(--color-primary);
            color: white;
        }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand-container">
            <div class="brand-logo-container">
                <svg class="svg-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 90L30 20L70 20L90 90" stroke="var(--color-primary)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="rgba(239, 68, 68, 0.05)"/>
                    <path d="M30 60L50 45L70 60" stroke="var(--color-primary)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/>
                    
                    <circle cx="50" cy="75" r="6" fill="var(--color-primary)">
                        <animate attributeName="r" values="6;8;6" dur="2s" repeatCount="indefinite" />
                        <animate attributeName="opacity" values="1;0.7;1" dur="2s" repeatCount="indefinite" />
                    </circle>
                </svg>
                <span class="brand-text">
                    Modo<br>Caverna
                </span>
            </div>
        </div>
        
        <nav class="nav-menu">
            <button class="nav-btn active" onclick="System.navigate('dashboard')">
                <i class="fas fa-chart-pie"></i> Visão Geral
            </button>
            <button class="nav-btn" onclick="System.navigate('financeiro')">
                <i class="fas fa-university"></i> Central Bancária
            </button>
            <button class="nav-btn" onclick="System.navigate('tarefas')">
                <i class="fas fa-tasks"></i> Tarefas
            </button>
            <button class="nav-btn" onclick="System.navigate('habitos')">
                <i class="fas fa-stopwatch"></i> Hábitos
            </button>
            <button class="nav-btn" onclick="System.navigate('biblioteca')">
                <i class="fas fa-book"></i> Biblioteca
            </button>
        </nav>

        <div class="youtube-widget">
            <div class="youtube-header">
                <i class="fab fa-youtube" style="color: #ff0000;"></i> FOCUS STATION
            </div>
            
            <div class="video-container">
                <iframe 
                    src="https://www.youtube.com/embed/9Lu9Y36uKtI?start=60&controls=1&modestbranding=1" 
                    title="YouTube video player" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    referrerpolicy="strict-origin-when-cross-origin" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="fade-in">
            <div class="header-title-group">
                <h1 class="mono" id="greeting-text">Inicializando Sistema...</h1>
                <p class="header-subtitle mono">> Usuário: Engenheiro | Nível de Acesso: Root</p>
            </div>
            <div class="system-status mono">
                <div class="status-dot"></div>
                SYSTEM ONLINE v6.0
            </div>
        </header>

        <div id="dashboard" class="view-section fade-in">
            <div class="grid-container">
                <div class="card col-4">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-wallet" style="margin-right:8px; color:var(--color-primary)"></i> Patrimônio Total</span>
                    </div>
                    <h2 class="mono" style="font-size: 2.5rem; font-weight: 700;">R$ <span id="dash-total-equity">0.00</span></h2>
                    <small style="color: var(--color-text-muted); margin-top: 5px;">Consolidado de todas as contas</small>
                </div>

                <div class="card col-4">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-check-double" style="margin-right:8px; color:var(--color-success)"></i> Produtividade</span>
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div>
                            <h2 style="font-size: 2rem;" id="dash-pending-tasks">0</h2>
                            <small class="mono" style="color: var(--color-text-muted);">Pendentes</small>
                        </div>
                        <div style="width: 1px; background: rgba(255,255,255,0.1);"></div>
                        <div>
                            <h2 style="font-size: 2rem;" id="dash-today-tasks">0</h2>
                            <small class="mono" style="color: var(--color-text-muted);">Para Hoje</small>
                        </div>
                    </div>
                </div>

                <div class="card col-4">
                    <div class="card-header"><span class="card-title">Performance</span></div>
                    <div style="height: 200px; position: relative;">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <div class="card col-6">
                    <div class="card-header"><span class="card-title">Distribuição de Ativos</span></div>
                    <div style="height: 250px; position: relative;">
                        <canvas id="distChart"></canvas>
                    </div>
                </div>

                <div class="card col-6">
                    <div class="card-header"><span class="card-title">Fluxo de Caixa (Mensal)</span></div>
                    <div style="height: 250px; position: relative;">
                        <canvas id="flowChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="financeiro" class="view-section hidden fade-in">
            <div class="grid-container">
                
                <div class="card col-6">
                    <div class="card-header">
                        <span class="card-title">Contas Vinculadas</span>
                        <button class="card-action-btn" onclick="UI.toggle('bank-add-form')">+ Nova Conta</button>
                    </div>

                    <div id="bank-add-form" class="hidden" style="margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                        <select id="bank-select" class="form-control">
                            <option value="Nubank">Nubank</option>
                            <option value="Inter">Banco Inter</option>
                            <option value="Banco do Brasil">Banco do Brasil</option>
                            <option value="Caixa">Caixa Econômica</option>
                        </select>
                        <input type="number" id="bank-balance-init" class="form-control" placeholder="Saldo Inicial (R$)">
                        <button class="btn-primary" onclick="FinanceModule.addAccount()">Salvar</button>
                    </div>

                    <div id="bank-list-container"></div>
                </div>

                <div class="card col-6">
                    <div class="card-header">
                        <span class="card-title">Registro de Operações</span>
                    </div>

                    <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed rgba(255,255,255,0.1);">
                        
                        <label style="font-size: 0.8rem; color: #888;">Data da Transação:</label>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="date" id="trans-date" class="form-control" style="margin-bottom: 0;">
                            <button class="btn-calendar" onclick="UI.openCalendar('trans-date')" title="Abrir Calendário">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                        </div>
                        
                        <input type="text" id="trans-desc" class="form-control" placeholder="Descrição (ex: Almoço, Freelance)">
                        
                        <div class="btn-group" style="margin-bottom: 10px;">
                            <input type="number" id="trans-val" class="form-control" placeholder="Valor (R$)" style="margin-bottom: 0;">
                            <select id="trans-account-select" class="form-control" style="margin-bottom: 0;">
                                <option value="" disabled selected>Selecione a Conta</option>
                            </select>
                        </div>
                        
                        <div class="btn-group" style="gap: 10px; width: 100%;">
                            <button class="btn-danger" onclick="FinanceModule.addTransaction('expense')">
                                <i class="fas fa-arrow-down"></i> Saída
                            </button>
                            <button class="btn-success" onclick="FinanceModule.addTransaction('income')">
                                <i class="fas fa-arrow-up"></i> Entrada
                            </button>
                        </div>
                    </div>

                    <div class="card-header" style="margin-bottom: 10px;">
                        <span class="card-title">Histórico Recente</span>
                    </div>
                    <div id="transaction-log" class="transaction-list"></div>
                </div>

            </div>
        </div>

        <div id="tarefas" class="view-section hidden fade-in">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="card-header">
                    <span class="card-title">Backlog de Execução</span>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                    <input type="text" id="task-input" class="form-control" placeholder="Nova tarefa..." style="margin-bottom: 0; flex: 2;">
                    
                    <div style="display: flex; gap: 5px;">
                        <input type="date" id="task-date" class="form-control" style="margin-bottom: 0; width: 130px;">
                        <button class="btn-calendar" onclick="UI.openCalendar('task-date')">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                    </div>
                    
                    <select id="task-prio" class="form-control" style="margin-bottom: 0; width: 100px;">
                        <option value="HIGH">Alta</option>
                        <option value="MED">Média</option>
                        <option value="LOW">Baixa</option>
                    </select>
                    <button class="btn-primary" style="width: auto;" onclick="TaskModule.add()">Push</button>
                </div>

                <div id="task-list-container"></div>
            </div>
        </div>

        <div id="habitos" class="view-section hidden fade-in">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Protocolo Diário</span>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; max-width: 600px;">
                    <input type="text" id="habit-input" class="form-control" placeholder="Novo hábito (ex: Leitura 20min)..." style="margin-bottom: 0;">
                    <button class="btn-primary" style="width: auto;" onclick="HabitModule.add()">Adicionar</button>
                </div>
                
                <div id="habit-list-container" class="habit-grid-container">
                    </div>
            </div>
        </div>

        <div id="biblioteca" class="view-section hidden fade-in">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="card-header">
                    <span class="card-title">Base de Conhecimento</span>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="book-input" class="form-control" placeholder="Título do Livro/Curso" style="margin-bottom: 0;">
                    <select id="book-type" class="form-control" style="width: 150px; margin-bottom: 0;">
                        <option value="book">Livro</option>
                        <option value="course">Curso</option>
                    </select>
                    <button class="btn-primary" style="width: auto;" onclick="LibraryModule.add()">Salvar</button>
                </div>
                <div id="library-list-container"></div>
            </div>
        </div>

    </main>

    <nav class="mobile-nav">
        <button class="mob-link active" onclick="System.navigate('dashboard')">
            <i class="fas fa-home"></i> Home
        </button>
        <button class="mob-link" onclick="System.navigate('financeiro')">
            <i class="fas fa-wallet"></i> Banco
        </button>
        <button class="mob-link" onclick="System.navigate('tarefas')">
            <i class="fas fa-check-square"></i> Tasks
        </button>
        <button class="mob-link" onclick="System.navigate('habitos')">
            <i class="fas fa-fire"></i> Hábitos
        </button>
        <button class="mob-link" onclick="System.navigate('biblioteca')">
            <i class="fas fa-book"></i> Lib
        </button>
    </nav>

    <script>
        /**
         * MODO CAVERNA OS v6.0 - SYSTEM KERNEL
         * Architecture: State-Based Single Page Application (SPA)
         */

        // --- 1. STATE MANAGEMENT ---
        const DB = {
            key: 'caverna_os_v6',
            state: {
                banks: [],
                transactions: [],
                tasks: [],
                habits: [],
                library: []
            },
            init() {
                const saved = localStorage.getItem(this.key);
                if (saved) this.state = JSON.parse(saved);
            },
            save() {
                localStorage.setItem(this.key, JSON.stringify(this.state));
                System.refreshAll();
            }
        };

        // --- 2. SYSTEM CONTROLLER ---
        const System = {
            init() {
                DB.init();
                this.updateGreeting();
                FinanceModule.init(); // <--- ADICIONE ISSO PARA INICIAR AS DATAS
                this.refreshAll();
            },

            updateGreeting() {
                const h = new Date().getHours();
                const d = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                document.getElementById('greeting-text').innerText = `${h < 12 ? 'Bom dia' : h < 18 ? 'Boa tarde' : 'Boa noite'}, Engenheiro.`;
                // Add sub-date logic if needed
            },

            navigate(viewId) {
                // Hide all views
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                // Show target
                document.getElementById(viewId).classList.remove('hidden');
                
                // Update Nav States (Desktop & Mobile)
                document.querySelectorAll('.nav-btn, .mob-link').forEach(el => el.classList.remove('active'));
                if (event && event.currentTarget) event.currentTarget.classList.add('active');

                // Trigger Chart Resize if needed
                if (viewId === 'dashboard' || viewId === 'financeiro') {
                    setTimeout(() => ChartsModule.renderAll(), 100);
                }
            },

            refreshAll() {
                FinanceModule.render();
                TaskModule.render();
                HabitModule.render();
                LibraryModule.render();
                ChartsModule.renderAll();
                this.updateDashboardKPIs();
            },

            updateDashboardKPIs() {
                const totalEquity = DB.state.banks.reduce((acc, b) => acc + b.balance, 0);
                document.getElementById('dash-total-equity').innerText = totalEquity.toFixed(2);
                document.getElementById('dash-pending-tasks').innerText = DB.state.tasks.filter(t => !t.done).length;
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dash-today-tasks').innerText = DB.state.tasks.filter(t => t.date === today).length;
            }
        };

        const UI = {
            toggle(id) { document.getElementById(id).classList.toggle('hidden'); },
            
            // NOVA FUNÇÃO: Abre o calendário nativo
            openCalendar(inputId) {
                const input = document.getElementById(inputId);
                if (input && input.showPicker) {
                    input.showPicker(); // Método moderno para abrir datepicker
                } else {
                    input.focus(); // Fallback
                }
            }
        };

        // --- 3. FINANCE MODULE ---
        const FinanceModule = {
            init() {
                // Define data de hoje nos calendários
                const today = new Date().toISOString().split('T')[0];
                const tDate = document.getElementById('trans-date');
                const kDate = document.getElementById('task-date');
                if (tDate) tDate.value = today;
                if (kDate) kDate.value = today;
            },

            addAccount() {
                const name = document.getElementById('bank-select').value;
                const bal = parseFloat(document.getElementById('bank-balance-init').value);
                if (name && !isNaN(bal)) {
                    DB.state.banks.push({ id: Date.now(), name, balance: bal });
                    document.getElementById('bank-balance-init').value = '';
                    UI.toggle('bank-add-form');
                    DB.save();
                }
            },

            deleteAccount(id) {
                if(confirm("Deseja apagar esta conta?")) {
                    DB.state.banks = DB.state.banks.filter(b => b.id !== id);
                    DB.save();
                }
            },

            editAccount(id) {
                const bank = DB.state.banks.find(b => b.id === id);
                if(bank) {
                    const novo = prompt("Novo saldo:", bank.balance);
                    if(novo && !isNaN(novo)) {
                        bank.balance = parseFloat(novo);
                        DB.save();
                    }
                }
            },

            addTransaction(type) {
                const desc = document.getElementById('trans-desc').value;
                const val = parseFloat(document.getElementById('trans-val').value);
                const accId = parseInt(document.getElementById('trans-account-select').value);
                const dateVal = document.getElementById('trans-date').value;

                if (desc && !isNaN(val) && accId && dateVal) {
                    const bank = DB.state.banks.find(b => b.id === accId);
                    if (bank) {
                        // Atualiza Saldo
                        if (type === 'income') bank.balance += val;
                        else bank.balance -= val;

                        // Salva Transação
                        const [ano, mes, dia] = dateVal.split('-'); // Formata data visual
                        DB.state.transactions.unshift({
                            id: Date.now(),
                            date: `${dia}/${mes}/${ano}`,
                            desc,
                            val,
                            type,
                            accName: bank.name
                        });

                        // Limpa campos
                        document.getElementById('trans-desc').value = '';
                        document.getElementById('trans-val').value = '';
                        DB.save();
                    }
                } else {
                    alert("Preencha todos os campos!");
                }
            },

            // --- NOVA FUNÇÃO: Excluir Transação do Histórico ---
            deleteTransaction(id) {
                const trans = DB.state.transactions.find(t => t.id === id);
                if (trans && confirm("Excluir transação? O saldo da conta será revertido.")) {
                    // Reverte o saldo no banco
                    const bank = DB.state.banks.find(b => b.name === trans.accName);
                    if (bank) {
                        if (trans.type === 'income') bank.balance -= trans.val; // Tira o que entrou
                        else bank.balance += trans.val; // Devolve o que saiu
                    }
                    // Remove da lista
                    DB.state.transactions = DB.state.transactions.filter(t => t.id !== id);
                    DB.save();
                }
            },

            // --- NOVA FUNÇÃO: Editar Transação ---
            editTransaction(id) {
                const trans = DB.state.transactions.find(t => t.id === id);
                if (!trans) return;

                const novaDesc = prompt("Nova descrição:", trans.desc);
                if (novaDesc === null) return;

                const novoValorStr = prompt("Novo valor (R$):", trans.val);
                const novoValor = parseFloat(novoValorStr);

                if (novaDesc && !isNaN(novoValor)) {
                    // Ajusta o saldo do banco se o valor mudou
                    if (novoValor !== trans.val) {
                        const bank = DB.state.banks.find(b => b.name === trans.accName);
                        if (bank) {
                            // Reverte valor antigo
                            if (trans.type === 'income') bank.balance -= trans.val;
                            else bank.balance += trans.val;
                            
                            // Aplica valor novo
                            if (trans.type === 'income') bank.balance += novoValor;
                            else bank.balance -= novoValor;
                        }
                    }
                    // Atualiza objeto
                    trans.desc = novaDesc;
                    trans.val = novoValor;
                    DB.save();
                }
            },

            render() {
                // Renderiza Bancos
                const list = document.getElementById('bank-list-container');
                const select = document.getElementById('trans-account-select');
                list.innerHTML = '';
                select.innerHTML = '<option value="" disabled selected>Selecione a Conta</option>';

                if (DB.state.banks.length === 0) list.innerHTML = '<p style="color:#666; text-align:center; padding:10px;">Nenhuma conta vinculada.</p>';

                DB.state.banks.forEach(b => {
                    let brandClass = '';
                    if (b.name === 'Nubank') brandClass = 'bank-nubank';
                    else if (b.name === 'Inter') brandClass = 'bank-inter';
                    else if (b.name === 'Banco do Brasil') brandClass = 'bank-bb';
                    else if (b.name === 'Caixa') brandClass = 'bank-caixa';

                    list.innerHTML += `
                        <div class="bank-card ${brandClass}">
                            <div class="bank-info">
                                <h4 class="mono">${b.name}</h4>
                                <div class="bank-balance">R$ ${b.balance.toFixed(2)}</div>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <i class="fas fa-edit" onclick="FinanceModule.editAccount(${b.id})" style="cursor:pointer; color:#666;" title="Editar Saldo"></i>
                                <i class="fas fa-trash" onclick="FinanceModule.deleteAccount(${b.id})" style="cursor:pointer; color:#666;" title="Apagar Conta"></i>
                            </div>
                        </div>
                    `;
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.innerText = b.name;
                    select.appendChild(opt);
                });

                // Renderiza Histórico com Botões de Editar/Excluir
                const log = document.getElementById('transaction-log');
                log.innerHTML = '';
                
                DB.state.transactions.slice(0, 30).forEach(t => {
                    const colorClass = t.type === 'income' ? 'amount-inc' : 'amount-exp';
                    const sign = t.type === 'income' ? '+' : '-';
                    
                    log.innerHTML += `
                        <div class="transaction-item">
                            <div class="trans-meta">
                                <span class="trans-desc">${t.desc}</span>
                                <span class="trans-date">${t.date} • ${t.accName}</span>
                            </div>
                            <div style="text-align:right;">
                                <div class="mono ${colorClass}" style="font-weight:bold;">${sign} R$ ${t.val.toFixed(2)}</div>
                                <div style="margin-top:4px; display:flex; gap:10px; justify-content:flex-end;">
                                    <i class="fas fa-pencil-alt" onclick="FinanceModule.editTransaction(${t.id})" style="cursor:pointer; font-size:0.8rem; color:#666;" title="Editar"></i>
                                    <i class="fas fa-trash-alt" onclick="FinanceModule.deleteTransaction(${t.id})" style="cursor:pointer; font-size:0.8rem; color:#ef4444;" title="Apagar"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
        };

        // --- 4. TASK MODULE ---
        const TaskModule = {
            add() {
                const desc = document.getElementById('task-input').value;
                const date = document.getElementById('task-date').value;
                const prio = document.getElementById('task-prio').value;

                if (desc) {
                    DB.state.tasks.push({ desc, date, prio, done: false });
                    document.getElementById('task-input').value = '';
                    DB.save();
                }
            },
            toggle(index) {
                DB.state.tasks[index].done = !DB.state.tasks[index].done;
                DB.save();
            },
            delete(index) {
                DB.state.tasks.splice(index, 1);
                DB.save();
            },
            render() {
                const list = document.getElementById('task-list-container');
                list.innerHTML = '';
                
                DB.state.tasks.forEach((t, i) => {
                    const prioClass = t.prio === 'HIGH' ? 'p-high' : (t.prio === 'MED' ? 'p-med' : 'p-low');
                    const doneStyle = t.done ? 'text-decoration: line-through; opacity: 0.5;' : '';
                    const icon = t.done ? 'fa-check-square' : 'fa-square';

                    list.innerHTML += `
                        <div class="task-item">
                            <div style="display:flex; align-items:center; cursor:pointer;" onclick="TaskModule.toggle(${i})">
                                <i class="far ${icon}" style="margin-right:10px; color:var(--color-primary)"></i>
                                <div>
                                    <span class="priority-badge mono ${prioClass}">${t.prio}</span>
                                    <span style="${doneStyle}">${t.desc}</span>
                                </div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <small class="mono" style="color:#666; font-size:0.7rem;">${t.date}</small>
                                <button onclick="TaskModule.delete(${i})" style="background:none; border:none; color:#444; cursor:pointer;"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
        };

        // --- 5. HABIT MODULE ---
        const HabitModule = {
            add() {
                const txt = document.getElementById('habit-input').value;
                if (txt) {
                    DB.state.habits.push({ txt, checks: Array(7).fill(false) });
                    document.getElementById('habit-input').value = '';
                    DB.save();
                }
            },
            toggle(hIdx, dayIdx) {
                DB.state.habits[hIdx].checks[dayIdx] = !DB.state.habits[hIdx].checks[dayIdx];
                DB.save();
            },
            delete(index) {
                DB.state.habits.splice(index, 1);
                DB.save();
            },
            render() {
                const container = document.getElementById('habit-list-container');
                container.innerHTML = '';

                DB.state.habits.forEach((h, i) => {
                    let checksHtml = '';
                    h.checks.forEach((isChecked, d) => {
                        const activeClass = isChecked ? 'checked' : '';
                        checksHtml += `<div class="day-check ${activeClass}" onclick="HabitModule.toggle(${i}, ${d})"></div>`;
                    });

                    container.innerHTML += `
                        <div class="habit-card-mini">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600;">${h.txt}</span>
                                <i class="fas fa-times" onclick="HabitModule.delete(${i})" style="cursor:pointer; color:#444; font-size:0.8rem;"></i>
                            </div>
                            <div class="habit-days">${checksHtml}</div>
                        </div>
                    `;
                });
            }
        };

        // --- 6. LIBRARY MODULE ---
        const LibraryModule = {
            add() {
                const title = document.getElementById('book-input').value;
                const type = document.getElementById('book-type').value;
                if(title) {
                    DB.state.library.push({ title, type });
                    document.getElementById('book-input').value = '';
                    DB.save();
                }
            },
            delete(i) {
                DB.state.library.splice(i, 1);
                DB.save();
            },
            render() {
                const list = document.getElementById('library-list-container');
                list.innerHTML = '';
                DB.state.library.forEach((item, i) => {
                    const icon = item.type === 'book' ? 'fa-book' : 'fa-laptop-code';
                    list.innerHTML += `
                        <div class="task-item">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <i class="fas ${icon}" style="color:var(--color-primary)"></i>
                                <span>${item.title}</span>
                            </div>
                            <button onclick="LibraryModule.delete(${i})" style="background:none; border:none; color:#444;"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                });
            }
        };

        // --- 7. SPOTIFY MODULE ---
        const SpotifyModule = {
            load() {
                let url = document.getElementById('spotify-link').value;
                const iframe = document.getElementById('spotify-frame');
                
                // Simple Parser for Spotify Links to Embeds
                if (url.includes('open.spotify.com')) {
                    // Replace /track/ with /embed/track/ logic handled by replacing base URL if needed
                    // Basic heuristic: if it doesn't have embed, add it
                    if (!url.includes('/embed')) {
                        url = url.replace('.com/', '.com/embed/');
                    }
                    // Clean queries
                    url = url.split('?')[0] + '?utm_source=generator&theme=0';
                    iframe.src = url;
                } else {
                    alert('Por favor, insira um link válido do Spotify (Playlist, Álbum ou Faixa).');
                }
            }
        };

        // --- 8. CHARTS MODULE (Chart.js) ---
        const ChartsModule = {
            instances: {},
            
            renderAll() {
                this.renderRadar();
                this.renderDist();
                this.renderFlow();
            },

            renderRadar() {
                const ctx = document.getElementById('radarChart');
                if (!ctx) return;
                
                // Calculate scores
                const tasksTotal = DB.state.tasks.length || 1;
                const tasksDone = DB.state.tasks.filter(t => t.done).length;
                const taskScore = (tasksDone / tasksTotal) * 100;
                
                // Static/Mock scores for demo purposes on specific dimensions
                const data = {
                    labels: ['Tarefas', 'Hábitos', 'Finanças', 'Estudo', 'Foco'],
                    datasets: [{
                        label: 'Nível Atual',
                        data: [taskScore, 60, 85, 70, 90],
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: '#ef4444',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#fff',
                        borderWidth: 1
                    }]
                };

                if (this.instances.radar) this.instances.radar.destroy();
                this.instances.radar = new Chart(ctx, {
                    type: 'radar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                angleLines: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { display: false, backdropColor: 'transparent' },
                                pointLabels: { color: '#888', font: { size: 10 } }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },

            renderDist() {
                const ctx = document.getElementById('distChart');
                if (!ctx) return;

                const labels = DB.state.banks.map(b => b.name);
                const values = DB.state.banks.map(b => b.balance);
                // Colors mapping
                const colors = labels.map(n => {
                    if(n === 'Nubank') return '#820ad1';
                    if(n === 'Inter') return '#ff7a00';
                    if(n === 'Banco do Brasil') return '#fce300';
                    return '#005ca9'; // Caixa fallback
                });

                if (this.instances.dist) this.instances.dist.destroy();
                this.instances.dist = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values.length ? values : [1], // Placeholder
                            backgroundColor: values.length ? colors : ['#333'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { legend: { position: 'right', labels: { color: '#888', boxWidth: 10 } } }
                    }
                });
            },

            renderFlow() {
                const ctx = document.getElementById('flowChart');
                if (!ctx) return;

                let income = 0, expense = 0;
                DB.state.transactions.forEach(t => {
                    if (t.type === 'income') income += t.val;
                    else expense += t.val;
                });

                if (this.instances.flow) this.instances.flow.destroy();
                this.instances.flow = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Entradas', 'Saídas'],
                        datasets: [{
                            label: 'R$',
                            data: [income, expense],
                            backgroundColor: ['#10b981', '#ef4444'],
                            borderRadius: 6,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666' } },
                            x: { grid: { display: false }, ticks: { color: '#fff' } }
                        }
                    }
                });
            }
        };

        // --- BOOTSTRAP ---
        window.addEventListener('DOMContentLoaded', () => {
            System.init();
        });

    </script>
</body>
</html>